<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualize</title>
    <link rel="stylesheet" href="../lib/photon-0.1.2-dist/css/photon.min.css">
    <link rel="stylesheet" href="../lib/layout/partition_layout.css">
    <link rel="stylesheet" href="../lib/contextMenu/jquery.contextMenu.min.css">
    <script>
      if (typeof module === 'object') {
        window.module = module;
        module = undefined;
      }
    </script>
    <script src="../lib/jquery-3.2.1.min.js"></script>
    <script src="../lib/contextMenu/jquery.contextMenu.js"></script>
    <script src="../lib/contextMenu/jquery.ui.position.min.js"></script>
    <!--<script src="../lib/d3.min.js"></script>-->
    <script>if (window.module) module = window.module;</script>
    <script src="../lib/date/date-en-US.js"></script>
    <script src="../lib/date/core.js"></script>
    <script src="../lib/date/parser.js"></script>
    <script src="../lib/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="../lib/jquery-ui.css">
    <script src="../lib/layout/partition_layout.js"></script>
    <script src="js/visUpdate.js"></script>
    <script src="js/uiLogic.js"></script>
    <link rel="stylesheet" href="css/main.css">

    <script>
      const { exec } = require('child_process');
      const fs = require('fs');
      let ipc = require('electron').ipcRenderer;
      let vis = require("@labvis-ufpa/vistechlib");
      let d3 = require('d3');
      let DataPreparation = require("./js/DataPreparation.js");
      console.log(vis);
      console.log(ipc);

      let _data_;
      let data_prep;
      let defautColor =["#006699","#24d068","#C53A10","#ff27ac",
        "#DBE70D","#08821e","#1135b2","#ff7043",
        "#78909c","#ECEDF0","#4D8000","#B33300",
        "#CC80CC","#66664D","#991AFF","#E666FF",
        "#4DB3FF","#1AB399","#E666B3","#33991A",
        "#CC9999","#B3B31A","#00E680","#4D8066",
        "#809980","#E6FF80","#1AFF33","#999933"];
      let addVis
        = (visName, parentElement) => {
        let pc = new vis[visName](parentElement);

        let div = d3.select(parentElement).append("div").attr("class","tooltip")
        pc
          .on("highlightstart",function(d,i){
            $(".partition-content").each(function(){
              if(this.__vis__ && this.__vis__ !== pc){
                this.__vis__.highlight(d,i);
              }
            });
          })
          .on("highlightend",function(d,i){
            $(".partition-content").each(function(){
              if(this.__vis__ && this.__vis__ !== pc){
                this.__vis__.removeHighlight(d,i);
              }
            });
          })
          .on("datamouseover",function(d,i){
            // pc.detail(d,i);
            pc.highlight(d,i);
            // pc.setLabel((d)=>{ return d.name; });



          })
          .on("dataclick",function(d,i){
            $(".partition-content").each(function(){
              if(this.__vis__){
                console.log("clicou", d, i);
                let elem = this.__vis__.getHighlightElement(i);
                // d3.select(elem).selectAll(".lineHighlight").style("stroke", "limegreen");
                this.__vis__.annotate(elem);

              }
            });
          });


        // $(".partition-content").each(function(){
        //   if(this.__vis__){
        //     let elem = this.__vis__;
        //     console.log("element",elem);
        //
        //     let g = d3.selectAll("svg")
        //     d3.selectAll("svg").call(d3.zoom()
        //       .scaleExtent([1, 5])
        //       .on("zoom", zoomed))
        //       .attr("transform", (d)=>{return "translate("+0+","+0+")";});;
        //
        //     // function zoomed() {
        //     //     g.attr("transform", d3.event.transform)
        //     //     g.scale(d3.event.transform.k, d3.event.transform.k);
        //     //
        //     //     // g.save();
        //     //     // g.clearRect(0, 0, width, height);
        //     //     // g.translate(d3.event.transform.x, d3.event.transform.y);
        //     //     // drawPoints();
        //     //     // g.restore();
        //     //
        //     // }
        //
        //
        //   }
        // });
        // let color = d3.scale.category10();
        // pc.settings.color = (d) =>{ return color(d["bar_size"])};
      };

      ipc.on('add-vis', function(event, arg){
        addVis(arg, $(".partition-content").get(0))
      });

      ipc.on('file-data',function (event,data) {
        _data_ = data;
        clean_menus();
        updatevis();
      });
      ipc.on('change-datasample', function(event, data){
        _data_ = data;
        clean_menus();
        updatevis();

      });

      ipc.on('cl', function(event, arg){
        console.log("from_main: ", arg);
      });


      $(document).ready(function() {

        ipc.send("document-ready");
        let $body = $("body");
        let partitionLayout = new PartitionLayout($body.get(0));

        $(window).resize(function(){
          $(".partition-content").each(function(){
            if(this.__vis__)
              this.__vis__.resize();
          });
        });

        $body.on("layout:resize", ".partition-node", function(e){
          let content = $(this).children(".partition-content").get(0);

          if(content && content.__vis__){
            content.__vis__.resize();
          }
        });
        $body.on("layout:created", ".partition-node", function(e){

          console.log("layout:created", this);
          if(this !== e.target)
            return;

          if($(this).children(".partition-content").children().is("button.btn.btn-large.btn-positive")) {
            $(this).children(".partition-content").children().attr("data-nodeid", $(this).attr("id"));
            return;
          }else
          if($(this).children(".partition-content").children().is("#menu_settings")){

            return
          }
          //verificar para abrir apenas um menu de settings
          $(".partition-content").each(function(i,item){
              $(item).children(".AddSettings").remove();
          });

          if(!$("#menu_settings").length) {
            $(this).children(".partition-content").append($("<button/>")
              .text(" view settings ")
              .addClass("AddSettings")
              .addClass("btn btn-large btn-positive")
              .addClass("icon icon-cog")
              .attr("data-nodeid", $(this).attr("id"))
              .css({ "float": "right" }));

            $.contextMenu({
              selector: '.AddSettings',
              trigger: 'left',
              callback: function (key) {
                if (_data_) {
                  let content = $("#" + $(this).attr("data-nodeid")).children(".partition-content");
                  // let content = $("#"+$(this).attr("data-nodeVis")).children(".partition-content");
                  let partition = $(this).parents('.partition-node').attr('id');
                  content.empty();
                  addMenu(key, content);
                  ipc.send('update-sampledata', {});
                  updateInteface();
                } else {
                  alert("You have to link data first");
                  ipc.send('not-data');
                }
              },
              items: {
                "menu settings visualization": { name: "settings visualization" }
              }

            });

          }
          $(this).children(".partition-content").append($("<button/>")
            .text("Add Visualization")
            .addClass("btn btn-large btn-positive")
            .attr("data-nodeid", $(this).attr("id"))
            .css({"float": "right"}));

          $.contextMenu({
            selector: '.btn.btn-large.btn-positive',
            trigger: 'left',
            callback: function (key) {
              if(_data_){
                let content = $("#"+$(this).attr("data-nodeid")).children(".partition-content");
                content.empty();
                addVis(key, content.get(0));
                ipc.send('update-sampledata', {});
                updatevis();
              }else{
                alert("You have to link data first");
                  ipc.send('not-data');
              }
            },
            items: {
              "ParallelCoordinates": {name: "Parallel Coordinates"},
              "ParallelBundling": {name: "Bundled Parallel Coordinates"},
              "ScatterplotMatrix": {name: "Scatter Plot"},
              "BeeswarmPlot": {name: "Beeswarm Plot"},
              "Treemap": {name: "Treemap"} ,
              "Histogram": {name: "Histogram"},
              "Sunburst": {name: "Sunburst"},
              "BarChart": {name: "Bar Chart"}
            }
          });

            $(this).children(".partition-content").append($("<button/>")
                .text("Download Visualizations")
                .addClass("btn btn-large btn-default")
                .attr("data-nodeid", $(this).attr("id"))
                .css({"float": "right"})
                .click(() => {
                    let viss = ["ParallelCoordinates", "ScatterplotMatrix", "BeeswarmPlot", "Histogram", "BarChart"];
                    for(let v of viss){
                        let element = document.createElement("div");
                        $(element).css({
                            "position":"fixed",
                            "width":"801px",
                            "height":"601px",
                            "opacity":"0"
                        });
                        document.body.appendChild(element);

                        let pc = new vis[v](element, {
                            size_type:"absolute",
                            width: "800px",
                            height: "600px"
                        });
                        pc.data(_data_);
                        pc.redraw();
                        let file = new Blob([element.innerHTML], {type: "image/svg+xml"});
                        let a = document.createElement("a");
                        let url = URL.createObjectURL(file);
                        a.href = url;
                        a.download = v+".svg";
                        document.body.appendChild(a);
                        //a.click();

                        let locationFile = __dirname.replace('pages', 'svgExported\\');

                        fs.writeFile(locationFile + v + ".svg", element.innerHTML, function(err) {
                          if(err) {
                            return console.log(err);
                          }
                          console.log("The file was saved!");
                        });

                        exec('"C:\\Program Files\\Inkscape\\inkscape.exe" ' + locationFile + v+'.svg' + ' --export-area-page --without-gui --export-pdf=' + locationFile + v+'.pdf', (err, stdout, stderr) => {
                          if (err) {
                            console.log(err);
                            return;
                          }
                          console.log(`stdout: ${stdout}`);
                          console.log(`stderr: ${stderr}`);
                        });

                        setTimeout(function() {
                            document.body.removeChild(a);
                            document.body.removeChild(element);
                            window.URL.revokeObjectURL(url);
                        }, 0);
                    }
                }));
        });
      });

    </script>



</head>
<body>

</body>
</html>